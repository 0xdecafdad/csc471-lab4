# Name:		Shaun Derstine
# Date:		4/2/2022
# Desc:		Runnable script that scans a log file to determine if a program is malware based on three heuristic rules...
#		(1) More than three word documents (docx) in ScapeGoat folder have been renamed.
#		(2) More than 3 files in ScapeGoat folder have been modified.
#		(3) The number of file self-deletes(a file been created and then deleted) activity is larger than or equal to 1.
# Output:	Prints "malware detected - HEUR:Trojan- Ransom.DocxEncrypt.Generic" if program is determined to be malware,
#		otherwise nothing

def main():
	# holds number of unique occurences for each type of activity
	activities_counter = {
		# File in ScapeGoat\ dir renamed
		"Files Renamed":0,
		# File in ScapeGoat\ dir modified
		"Files Modified":0,
		# File created and destroyed by program
		"Files Self-Deleted":0,
	}

	with open("./log.txt", "r") as log_file:
		files_renamed = [] # holds all files that have been renamed
		files_modified = [] # holds all files that have been modified
		files_created = [] # holds all files that have been created
		# read each line of file
		for line in log_file:
			line_split = line.split(":")
			# need this because readline() so kindly 
			# scans an empty line after each actual line
			if not line_split[0] == "\n":
				# can be "File Rename", "File Modify", "File Delete", "File Create"
				# describes the type of activity program performed
				activity = line_split[0]
				# file that activity has been performed on
				file = line_split[1]

				# check type of activity, then perform action depending on which
				if "File Rename" in activity:
					# check if file is in ScapeGoat\ dir and 
					# if it has already been renamed
					if "ScapeGoat\\" in file and not file in files_renamed:
						files_renamed.append(file)
						activities_counter["Files Renamed"] += 1
				elif "File Modify" in activity:
					# check if file is in ScapeGoat\ dir and
					# if it has already been modified
					if "ScapeGoat\\" in file and not file in files_modified:
						files_modified.append(file)
						activities_counter["Files Modified"] += 1
				elif "File Create" in activity:
					files_created.append(file)
				elif "File Delete" in activity:
					# if deleted file was previously created by the program,
					# then it is a self-delete
					if file in files_created:
						activities_counter["Files Self-Deleted"] += 1

	# More than three word documents (docx) in ScapeGoat folder have been renamed.
	# More than 3 files in ScapeGoat folder have been modified.
	# The number of file self-deletes(a file been created and then deleted) activity is larger
	# than or equal to 1
	if activities_counter["Files Renamed"] > 3 and activities_counter["Files Modified"] > 3 and activities_counter["Files Self-Deleted"] >= 1:
		print("malware detected - HEUR:Trojan- Ransom.DocxEncrypt.Generic")

	# Debugging
	# print(activities_counter["Files Renamed"])
	# print(activities_counter["Files Modified"])
	# print(activities_counter["Files Self-Deleted"])

if __name__ == "__main__":
	main()
